<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Cobros</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .container {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        .collection-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }
    </style>
    <!-- Íconos para la pantalla de inicio (Web App Manifest y Apple Touch Icon) -->
    <link rel="icon" href="https://placehold.co/192x192/007bff/ffffff?text=CobrosApp" sizes="any" type="image/png">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/007bff/ffffff?text=CobrosApp">
    <link rel="manifest" href="/manifest.json"> <!-- Puedes crear este archivo para un control más detallado -->
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="container bg-white rounded-xl shadow-lg p-6 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Gestor de Cobros</h1>
        <p class="text-center text-sm text-gray-600 mb-4">Tu ID de Usuario: <span id="userIdDisplay" class="font-bold text-blue-700">Cargando...</span></p>


        <form id="collectionForm" class="grid grid-cols-1 gap-4">
            <div>
                <label for="name" class="block text-gray-700 text-sm font-semibold mb-2">Nombre:</label>
                <input type="text" id="name" name="name" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <!-- Nuevo campo para productos -->
            <div>
                <label for="products" class="block text-gray-700 text-sm font-semibold mb-2">Productos:</label>
                <input type="text" id="products" name="products"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <!-- Fin nuevo campo -->

            <div>
                <label for="startDate" class="block text-gray-700 text-sm font-semibold mb-2">Fecha de Inicio:</label>
                <input type="date" id="startDate" name="startDate" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div>
                <label for="money" class="block text-gray-700 text-sm font-semibold mb-2">Dinero (Monto Total):</label>
                <input type="number" id="money" name="money" step="0.01" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div>
                <label for="dueDate" class="block text-gray-700 text-sm font-semibold mb-2">Fecha de Deuda (Vencimiento):</label>
                <input type="date" id="dueDate" name="dueDate" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div>
                <label for="moneyOwed" class="block text-gray-700 text-sm font-semibold mb-2">Dinero Adeudado:</label>
                <input type="number" id="moneyOwed" name="moneyOwed" step="0.01" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <button type="submit"
                    class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 mt-4">
                Agregar Cobro
            </button>
        </form>

        <button id="showCollectionsButton"
                class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 mt-4">
            Mostrar Cobros del Día
        </button>

        <!-- Nueva sección para mostrar todos los cobros ingresados -->
        <div class="mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Todos los Cobros Ingresados</h2>
            <div class="flex gap-2 mb-4">
                <button id="downloadJsonButton"
                    class="bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    Descargar Datos (.json)
                </button>
                <button id="downloadPdfButton"
                    class="bg-pink-600 text-white py-2 px-4 rounded-lg hover:bg-pink-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-pink-500">
                    Descargar PDF
                </button>
            </div>
            <div id="allCollectionsList" class="grid grid-cols-1 gap-4">
                <!-- Todos los cobros se cargarán aquí -->
                <p id="noAllCollectionsMessage" class="hidden text-gray-600 italic">Aún no hay cobros ingresados.</p>
                <div id="loadingMessage" class="text-center text-gray-500">Cargando cobros...</div>
            </div>
        </div>
    </div>

    <!-- Modal para mostrar cobros -->
    <div id="collectionsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="document.getElementById('collectionsModal').style.display = 'none';">&times;</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Cobros para el <span id="modalDate"></span></h2>

            <div class="flex flex-col md:flex-row items-center mb-4 gap-2">
                <label for="modalDatePicker" class="block text-gray-700 text-sm font-semibold">Selecciona la fecha:</label>
                <input type="date" id="modalDatePicker"
                       class="w-full md:w-auto px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="searchModalDateButton"
                        class="w-full md:w-auto bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Ver Cobros
                </button>
            </div>

            <div id="collectionsList" class="text-gray-700">
                <!-- Los cobros se cargarán aquí -->
            </div>
            <p id="noCollectionsMessage" class="hidden text-gray-600 italic mt-4">No hay cobros para este día.</p>
        </div>
    </div>

    <script type="module">
    // --- LocalStorage Variables y Utilidades ---
    const STORAGE_KEY = 'cobros';
    let collections = [];

    // DOM element references
    const collectionForm = document.getElementById('collectionForm');
    const showCollectionsButton = document.getElementById('showCollectionsButton');
    const collectionsModal = document.getElementById('collectionsModal');
    const modalDateSpan = document.getElementById('modalDate');
    const collectionsListDiv = document.getElementById('collectionsList');
    const noCollectionsMessage = document.getElementById('noCollectionsMessage');
    const allCollectionsListDiv = document.getElementById('allCollectionsList');
    const noAllCollectionsMessage = document.getElementById('noAllCollectionsMessage');
    const modalDatePicker = document.getElementById('modalDatePicker');
    const searchModalDateButton = document.getElementById('searchModalDateButton');
    const userIdDisplay = document.getElementById('userIdDisplay');
    const loadingMessage = document.getElementById('loadingMessage');
    const downloadJsonButton = document.getElementById('downloadJsonButton'); // <-- Referencia al botón
    const downloadPdfButton = document.getElementById('downloadPdfButton');

    // --- LocalStorage CRUD ---
    function loadCollections() {
        const data = localStorage.getItem(STORAGE_KEY);
        collections = data ? JSON.parse(data) : [];
    }

    function saveCollections() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(collections));
    }

    function addCollection(collection) {
        collections.push(collection);
        saveCollections();
    }

    function removeCollection(idToDelete) {
        collections = collections.filter(c => c.id !== idToDelete);
        saveCollections();
    }

    // --- UI Rendering Functions ---
    function renderCollectionItem(collectionItem) {
        const itemDiv = document.createElement('div');
        itemDiv.classList.add('bg-blue-50', 'p-3', 'rounded-lg', 'shadow-sm', 'border', 'border-blue-100', 'collection-item', 'mb-2');
        itemDiv.innerHTML = `
            <div>
                <p class="font-semibold text-lg text-blue-800">${collectionItem.name}</p>
                <p class="text-sm text-gray-600">Productos: ${collectionItem.products || 'N/A'}</p>
                <p class="text-sm text-gray-600">Inicio: ${collectionItem.startDate}</p>
                <p class="text-sm text-gray-600">Monto Total: <span class="font-medium">$${Number(collectionItem.money).toFixed(2)}</span></p>
                <p class="text-sm text-gray-600">Vencimiento: <span class="font-medium">${collectionItem.dueDate}</span></p>
                <p class="text-lg font-bold text-red-600 mt-2">Adeudado: $${Number(collectionItem.moneyOwed).toFixed(2)}</p>
            </div>
            <button onclick="deleteCollection('${collectionItem.id}')" class="bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500">
                🗑️
            </button>
        `;
        return itemDiv;
    }

    function updateAllCollectionsList() {
        allCollectionsListDiv.innerHTML = '';
        if (collections.length > 0) {
            noAllCollectionsMessage.classList.add('hidden');
            collections.forEach(collection => {
                allCollectionsListDiv.appendChild(renderCollectionItem(collection));
            });
        } else {
            noAllCollectionsMessage.classList.remove('hidden');
        }
    }

    // --- Event Handlers ---

    // Eliminar un cobro
    function deleteCollection(idToDelete) {
        removeCollection(idToDelete);
        updateAllCollectionsList();
        // Si el modal está abierto, refrescar la lista del modal
        if (collectionsModal.style.display === 'flex') {
            displayDailyCollections(modalDatePicker.value);
        }
    }
    window.deleteCollection = deleteCollection; // Make it globally accessible

    // Agregar un cobro
    collectionForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const name = document.getElementById('name').value;
        const products = document.getElementById('products').value;
        const startDate = document.getElementById('startDate').value;
        const money = parseFloat(document.getElementById('money').value);
        const dueDate = document.getElementById('dueDate').value;
        const moneyOwed = parseFloat(document.getElementById('moneyOwed').value);
        const newCollectionData = {
            id: Date.now().toString(), // ID único local
            name,
            products,
            startDate,
            money,
            dueDate,
            moneyOwed
        };
        addCollection(newCollectionData);
        collectionForm.reset();
        updateAllCollectionsList();
    });

    showCollectionsButton.addEventListener('click', function() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        modalDatePicker.value = `${year}-${month}-${day}`;
        collectionsModal.style.display = 'flex';
        displayDailyCollections(modalDatePicker.value);
    });

    searchModalDateButton.addEventListener('click', function() {
        const selectedDate = modalDatePicker.value;
        if (selectedDate) {
            displayDailyCollections(selectedDate);
        } else {
            alert('Por favor, seleccione una fecha.');
        }
    });

    function displayDailyCollections(dateString) {
        const dateToFilter = new Date(dateString);
        const formattedDateToFilter = dateToFilter.toISOString().split('T')[0];
        const dailyCollections = collections.filter(collection => {
            const collectionDueDate = new Date(collection.dueDate);
            return collectionDueDate.toISOString().split('T')[0] === formattedDateToFilter;
        });
        collectionsListDiv.innerHTML = '';
        modalDateSpan.textContent = dateString;
        if (dailyCollections.length > 0) {
            noCollectionsMessage.classList.add('hidden');
            dailyCollections.forEach(collection => {
                collectionsListDiv.appendChild(renderCollectionItem(collection));
            });
        } else {
            noCollectionsMessage.classList.remove('hidden');
        }
    }

    window.addEventListener('click', function(event) {
        if (event.target == collectionsModal) {
            collectionsModal.style.display = 'none';
        }
    });

    // Descargar datos en JSON
    downloadJsonButton.addEventListener('click', function() {
        if (collections.length === 0) {
            alert('No hay cobros para descargar.');
            return;
        }
        const dataStr = JSON.stringify(collections, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = 'cobros.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

    // Descargar datos en PDF
    downloadPdfButton.addEventListener('click', function() {
        // Filtrar cobros con dinero adeudado mayor a 0
        const filteredCollections = collections.filter(c => Number(c.moneyOwed) > 0);

        if (filteredCollections.length === 0) {
            alert('No hay cobros para descargar.');
            return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.text('Todos los Cobros Ingresados', 14, 14);

        const tableColumn = [
            "Nombre",
            "Productos",
            "Inicio",
            "Monto Total",
            "Vencimiento",
            "Adeudado"
        ];
        const tableRows = filteredCollections.map(c => [
            c.name,
            c.products || '',
            c.startDate,
            `$${Number(c.money).toFixed(2)}`,
            c.dueDate,
            `$${Number(c.moneyOwed).toFixed(2)}`
        ]);

        doc.autoTable({
            head: [tableColumn],
            body: tableRows,
            startY: 20,
            styles: { fontSize: 10 }
        });

        doc.save('cobros.pdf');
    });

    // Inicializar datos locales y UI al cargar
    window.onload = function() {
        userIdDisplay.textContent = 'Local';
        loadingMessage.classList.add('hidden');
        loadCollections();
        updateAllCollectionsList();
    };
    </script>
    <!-- Agrega estas librerías antes del cierre de </body> si no las tienes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</body>
</html>
